console.log("NordSales service worker initialized");let n=null;chrome.tabs.onUpdated.addListener((e,t,r)=>{t.status==="complete"&&r.url&&r.url.includes("crm.dynamics.com")?(n=e,console.log("Dynamics CRM tab updated:",e),chrome.storage.local.get(["autoOpen"],o=>{o.autoOpen&&(chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#0078d4"}))})):t.status==="complete"&&r.url&&!r.url.includes("crm.dynamics.com")&&chrome.action.setBadgeText({text:""})});chrome.tabs.onActivated.addListener(async e=>{try{const t=await chrome.tabs.get(e.tabId);t.url&&t.url.includes("crm.dynamics.com")&&(n=e.tabId,console.log("Dynamics CRM tab activated:",e.tabId))}catch(t){console.error("Error getting tab info:",t)}});chrome.action.onClicked.addListener(e=>{chrome.sidePanel.open({tabId:e.id}).then(()=>{chrome.action.setBadgeText({text:""})}).catch(t=>{console.error("Error opening side panel:",t)})});chrome.runtime.onMessage.addListener((e,t,r)=>{if(console.log("Service worker received message:",e.type),e.type==="OPPORTUNITY_DETECTED")console.log("Received opportunity ID:",e.opportunityId),chrome.storage.local.set({currentOpportunityId:e.opportunityId,lastUpdated:e.timestamp||Date.now()}),chrome.runtime.sendMessage(e).catch(o=>{console.log("Could not forward message to side panel (probably not open)")});else if(e.type==="OPPORTUNITY_CLEARED")console.log("Opportunity cleared"),chrome.storage.local.remove(["currentOpportunityId","lastUpdated"]),chrome.runtime.sendMessage(e).catch(o=>{console.log("Could not forward message to side panel")});else if(e.type==="POPUP_OPENED"){if(console.log("Side panel opened, checking for current opportunity"),n)try{chrome.tabs.sendMessage(n,{type:"GET_OPPORTUNITY_ID"},o=>{if(chrome.runtime.lastError){console.log("Could not communicate with content script:",chrome.runtime.lastError);return}o&&o.opportunityId&&(console.log("Got opportunity ID from content script:",o.opportunityId),chrome.storage.local.set({currentOpportunityId:o.opportunityId,lastUpdated:Date.now()}),chrome.runtime.sendMessage({type:"OPPORTUNITY_DETECTED",opportunityId:o.opportunityId,timestamp:Date.now()}).catch(c=>{console.log("Could not send to side panel:",c)}))})}catch(o){console.error("Error checking for opportunity:",o)}}else e.type==="SET_AUTO_OPEN"&&(chrome.storage.local.set({autoOpen:e.enabled}),r({success:!0}));return!0});chrome.runtime.onInstalled.addListener(()=>{console.log("NordSales extension installed/updated"),chrome.storage.local.get(["autoOpen"],e=>{e.autoOpen===void 0&&chrome.storage.local.set({autoOpen:!0})})});
