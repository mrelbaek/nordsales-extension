console.log("NordSales service worker initialized");let l=null;const r={};function a(e){chrome.tabs.get(e).then(n=>{n&&n.url&&n.url.includes("crm.dynamics.com")?chrome.tabs.sendMessage(e,{type:"CHECK_OPPORTUNITY_ID"},o=>{if(chrome.runtime.lastError){console.log("Message error:",chrome.runtime.lastError.message),chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}).catch(t=>{console.log("Error re-injecting content script:",t)});return}o&&o.opportunityId?chrome.storage.local.get(["currentOpportunityId"],t=>{t.currentOpportunityId!==o.opportunityId&&(chrome.storage.local.set({currentOpportunityId:o.opportunityId,lastUpdated:Date.now(),currentUrl:o.url}),chrome.runtime.sendMessage({type:"OPPORTUNITY_DETECTED",opportunityId:o.opportunityId,timestamp:Date.now()}).catch(()=>{}))}):chrome.storage.local.get(["currentOpportunityId"],t=>{t.currentOpportunityId&&(chrome.storage.local.remove(["currentOpportunityId","lastUpdated"]),chrome.runtime.sendMessage({type:"OPPORTUNITY_CLEARED",timestamp:Date.now()}).catch(()=>{}))})}):r[e]&&(clearInterval(r[e]),delete r[e])}).catch(()=>{r[e]&&(clearInterval(r[e]),delete r[e])})}function s(e){r[e]&&clearInterval(r[e]),r[e]=setInterval(()=>{a(e)},1e3)}chrome.tabs.onUpdated.addListener((e,n,o)=>{n.status==="complete"&&o.url&&o.url.includes("crm.dynamics.com")?(l=e,console.log("Dynamics CRM tab updated:",e),chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}).then(()=>{s(e)}).catch(t=>{console.error("Error injecting content script:",t)}),chrome.storage.local.get(["autoOpen"],t=>{t.autoOpen!==!1&&(chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#0078d4"}))})):n.status==="complete"&&o.url&&!o.url.includes("crm.dynamics.com")&&chrome.action.setBadgeText({text:""})});chrome.tabs.onRemoved.addListener(e=>{r[e]&&(clearInterval(r[e]),delete r[e])});chrome.action.onClicked.addListener(e=>{chrome.sidePanel.open({tabId:e.id}).then(()=>{chrome.action.setBadgeText({text:""})}).catch(n=>{console.error("Error opening side panel:",n)})});chrome.runtime.onMessage.addListener((e,n,o)=>(console.log("Service worker received message:",e.type),e.type==="OPPORTUNITY_DETECTED"?(console.log("Received opportunity ID:",e.opportunityId),chrome.storage.local.set({currentOpportunityId:e.opportunityId,lastUpdated:e.timestamp||Date.now()}),chrome.runtime.sendMessage(e).catch(t=>{console.log("Could not forward message to side panel (probably not open)")})):e.type==="OPPORTUNITY_CLEARED"?(console.log("Opportunity cleared"),chrome.storage.local.remove(["currentOpportunityId","lastUpdated"]),chrome.runtime.sendMessage(e).catch(t=>{console.log("Could not forward message to side panel")})):e.type==="POPUP_OPENED"?(console.log("Side panel opened, checking for current opportunity"),l&&chrome.tabs.get(l).then(t=>{t&&t.url&&t.url.includes("crm.dynamics.com")&&chrome.tabs.sendMessage(l,{type:"CHECK_OPPORTUNITY_ID"},c=>{if(chrome.runtime.lastError){console.log("Error communicating with content script:",chrome.runtime.lastError.message);return}c&&c.opportunityId&&(console.log("Got opportunity ID from content script:",c.opportunityId),chrome.storage.local.set({currentOpportunityId:c.opportunityId,lastUpdated:Date.now()}),chrome.runtime.sendMessage({type:"OPPORTUNITY_DETECTED",opportunityId:c.opportunityId,timestamp:Date.now()}).catch(i=>{console.log("Could not send to side panel:",i)}))})}).catch(t=>{console.log("Tab no longer exists:",t)})):e.type==="SET_AUTO_OPEN"&&(chrome.storage.local.set({autoOpen:e.enabled}),o({success:!0})),!0));chrome.runtime.onInstalled.addListener(()=>{console.log("NordSales extension installed/updated"),chrome.storage.local.get(["autoOpen"],e=>{e.autoOpen===void 0&&chrome.storage.local.set({autoOpen:!0})})});
