console.log("NordSales service worker initialized");const c={};function l(e){const o=/https:\/\/([^.]+)\.crm\.dynamics\.com/i,t=e.match(o);return t&&t.length>1?t[1]:null}async function p(e,o){try{const t=await chrome.tabs.get(e);if(!t||!t.url||!t.url.includes("crm.dynamics.com"))return console.warn("Tab is not a Dynamics CRM tab"),!1;const r=t.url.match(/(https:\/\/[^\/]+)/);if(!r)return console.warn("Could not extract base URL from tab"),!1;const a=`${r[1]}/main.aspx?etn=opportunity&pagetype=entityrecord&id=${o}`;return await chrome.tabs.update(e,{url:a}),setTimeout(()=>{chrome.tabs.sendMessage(e,{type:"CHECK_OPPORTUNITY_ID"},i=>{if(chrome.runtime.lastError){console.warn("CHECK_OPPORTUNITY_ID error:",chrome.runtime.lastError.message);return}i&&i.opportunityId&&(chrome.storage.local.set({currentOpportunityId:i.opportunityId,lastUpdated:Date.now()}),chrome.runtime.sendMessage({type:"OPPORTUNITY_DETECTED",opportunityId:i.opportunityId}))})},1500),setTimeout(()=>{u(e)},1e3),!0}catch(t){return console.warn("Error navigating to opportunity:",t),!1}}function u(e){chrome.tabs.get(e).then(o=>{if(o&&o.url&&o.url.includes("crm.dynamics.com")){const t=l(o.url);t&&chrome.storage.local.set({currentOrgId:t,lastOrgIdUpdated:Date.now()}),chrome.tabs.sendMessage(e,{type:"CHECK_OPPORTUNITY_ID"},r=>{if(chrome.runtime.lastError){console.error("Message error:",chrome.runtime.lastError.message),chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}).catch(n=>{console.error("Error re-injecting content script:",n)});return}r&&r.opportunityId?(chrome.storage.local.set({currentOpportunityId:r.opportunityId,lastUpdated:Date.now()}),chrome.runtime.sendMessage({type:"OPPORTUNITY_DETECTED",opportunityId:r.opportunityId,organizationId:r.organizationId||t,timestamp:Date.now()}).catch(()=>{})):(chrome.storage.local.remove(["currentOpportunityId","lastUpdated"]),chrome.runtime.sendMessage({type:"OPPORTUNITY_CLEARED"}).catch(()=>{}))})}else clearInterval(c[e]),delete c[e]}).catch(()=>{clearInterval(c[e]),delete c[e]})}function d(e){c[e]&&clearInterval(c[e]),c[e]=setInterval(()=>{u(e)},2e3)}chrome.tabs.onUpdated.addListener((e,o,t)=>{if(o.status==="complete"&&t.url&&t.url.includes("crm.dynamics.com")){const r=l(t.url);r&&chrome.storage.local.set({currentOrgId:r}),chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}).then(()=>{d(e)}).catch(n=>{console.error("Error injecting content script:",n)}),chrome.storage.local.get(["autoOpen"],n=>{n.autoOpen!==!1&&(chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#0078d4"}))})}else o.status==="complete"&&t.url&&!t.url.includes("crm.dynamics.com")&&chrome.action.setBadgeText({text:""})});chrome.tabs.onRemoved.addListener(e=>{c[e]&&(clearInterval(c[e]),delete c[e])});chrome.action.onClicked.addListener(e=>{chrome.sidePanel.open({tabId:e.id}).then(()=>{chrome.action.setBadgeText({text:""})}).catch(o=>{console.error("Error opening side panel:",o)})});chrome.runtime.onMessage.addListener((e,o,t)=>{if(e.type==="OPPORTUNITY_DETECTED")return chrome.storage.local.set({currentOpportunityId:e.opportunityId,lastUpdated:e.timestamp||Date.now()}),chrome.runtime.sendMessage(e).catch(r=>{console.warn("Could not forward message to side panel (probably not open)")}),t({success:!0}),!0;if(e.type==="OPPORTUNITY_CLEARED"){if(globalThis.lastClearedTimestamp&&Date.now()-globalThis.lastClearedTimestamp<500){console.log("Duplicate opportunity clear message, skipping");return}return globalThis.lastClearedTimestamp=Date.now(),chrome.runtime.sendMessage(e).catch(r=>{console.warn("Could not forward message to side panel",r)}),t({success:!0}),!0}return e.type==="POPUP_OPENED"?(chrome.tabs.query({active:!0,url:"*://*.crm.dynamics.com/*"},r=>{if(r&&r.length>0){const n=r[0].id;chrome.tabs.get(n).then(a=>{const i=l(a.url);i&&chrome.storage.local.set({currentOrgId:i}),chrome.scripting.executeScript({target:{tabId:n},files:["contentScript.js"]}).then(()=>{chrome.tabs.sendMessage(n,{type:"CHECK_OPPORTUNITY_ID"},s=>{if(chrome.runtime.lastError){console.warn("Error communicating with content script:",chrome.runtime.lastError.message);return}s&&s.opportunityId&&(chrome.storage.local.set({currentOpportunityId:s.opportunityId,lastUpdated:Date.now()}),chrome.runtime.sendMessage({type:"OPPORTUNITY_DETECTED",opportunityId:s.opportunityId,organizationId:s.organizationId||i}).catch(m=>{console.warn("Could not send to side panel:",m)}))})}).catch(s=>{console.error("Error injecting content script from POPUP_OPENED:",s)})}).catch(a=>{console.warn("Tab no longer exists:",a)})}}),t({success:!0}),!0):e.type==="NAVIGATE_TO_OPPORTUNITY"?(chrome.tabs.query({active:!0,currentWindow:!0},async r=>{if(r&&r.length>0){const n=r[0].id,a=await p(n,e.opportunityId);t({success:a})}else t({success:!1,error:"No active tab found"})}),!0):e.type==="SET_AUTO_OPEN"?(chrome.storage.local.set({autoOpen:e.enabled}),t({success:!0}),!0):(t({success:!1,error:"Unknown message type"}),!0)});chrome.runtime.onInstalled.addListener(()=>{console.log("Lens extension installed/updated"),chrome.storage.local.get(["autoOpen","currentOrgId"],e=>{e.autoOpen===void 0&&chrome.storage.local.set({autoOpen:!0})})});
