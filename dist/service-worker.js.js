const a={},i={},s=new Set;function d(e){const r=/https:\/\/([^.]+)\.crm\.dynamics\.com/i,t=e.match(r);return t&&t.length>1?t[1]:null}function u(e){return e&&e.includes("crm.dynamics.com")}async function m(){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!e)return;const r=u(e.url);if(chrome.runtime.sendMessage({type:"TAB_CONTEXT_UPDATE",isCRM:r}).catch(()=>{}),r){chrome.storage.local.get(["autoOpen"],o=>{o.autoOpen!==!1&&(chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#0078d4"}))});const t=d(e.url);t&&chrome.storage.local.set({currentOrgId:t,lastOrgIdUpdated:Date.now()}),s.add(e.id),i[e.id]=!1,p(e.id).then(()=>{T(e.id)}).catch(o=>{})}else chrome.action.setBadgeText({text:""})}catch{}}async function f(e,r){try{const t=await chrome.tabs.get(e);if(!t||!t.url||!u(t.url))return!1;const o=t.url.match(/(https:\/\/[^\/]+)/);if(!o)return console.warn("Could not extract base URL from tab"),!1;const c=`${o[1]}/main.aspx?etn=opportunity&pagetype=entityrecord&id=${r}`;return await chrome.tabs.update(e,{url:c}),setTimeout(async()=>{await p(e),chrome.tabs.sendMessage(e,{type:"CHECK_OPPORTUNITY_ID"},l=>{if(chrome.runtime.lastError){console.warn("CHECK_OPPORTUNITY_ID error:",chrome.runtime.lastError.message);return}l&&l.opportunityId&&(chrome.storage.local.set({currentOpportunityId:l.opportunityId,lastUpdated:Date.now()}),chrome.runtime.sendMessage({type:"OPPORTUNITY_DETECTED",opportunityId:l.opportunityId}).catch(()=>{}))})},1500),setTimeout(()=>{h(e)},2e3),!0}catch(t){return console.warn("Error navigating to opportunity:",t),!1}}async function p(e){try{const r=await chrome.tabs.get(e);return!r||!r.url||!u(r.url)?!1:i[e]?!0:(await chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}),i[e]=!0,new Promise(t=>setTimeout(t,500)))}catch(r){return console.warn("Error ensuring content script:",r),!1}}async function h(e){try{const r=await chrome.tabs.get(e);if(!r||!r.url||!u(r.url)){clearInterval(a[e]),delete a[e],delete i[e],s.delete(e);return}const t=d(r.url);t&&chrome.storage.local.set({currentOrgId:t,lastOrgIdUpdated:Date.now()}),await p(e);const n=await(()=>new Promise(c=>{chrome.tabs.sendMessage(e,{type:"CHECK_OPPORTUNITY_ID"},l=>{if(chrome.runtime.lastError){i[e]=!1,c(null);return}c(l)}),setTimeout(()=>c(null),1e3)}))();n&&n.opportunityId?(chrome.storage.local.set({currentOpportunityId:n.opportunityId,lastUpdated:Date.now()}),chrome.runtime.sendMessage({type:"OPPORTUNITY_DETECTED",opportunityId:n.opportunityId,organizationId:n.organizationId||t,timestamp:Date.now()}).catch(()=>{})):(chrome.storage.local.remove(["currentOpportunityId","lastUpdated"]),chrome.runtime.sendMessage({type:"OPPORTUNITY_CLEARED"}).catch(()=>{}))}catch{clearInterval(a[e]),delete a[e],delete i[e],s.delete(e)}}function T(e){a[e]&&clearInterval(a[e]),a[e]=setInterval(()=>{h(e)},2e3)}chrome.tabs.onUpdated.addListener((e,r,t)=>{r.status==="complete"&&(u(t.url)?s.add(e):s.delete(e),m())});chrome.tabs.onActivated.addListener(async e=>{m()});chrome.tabs.onRemoved.addListener(e=>{a[e]&&(clearInterval(a[e]),delete a[e],delete i[e],s.delete(e))});chrome.action.onClicked.addListener(e=>{chrome.sidePanel.open({tabId:e.id}).then(()=>{chrome.action.setBadgeText({text:""})}).catch(r=>{console.error("Error opening side panel:",r)})});chrome.runtime.onMessage.addListener((e,r,t)=>e.type==="OPPORTUNITY_DETECTED"?(chrome.storage.local.set({currentOpportunityId:e.opportunityId,lastUpdated:e.timestamp||Date.now()}),chrome.runtime.sendMessage(e).catch(o=>{}),t({success:!0}),!0):e.type==="OPPORTUNITY_CLEARED"?globalThis.lastClearedTimestamp&&Date.now()-globalThis.lastClearedTimestamp<500?void 0:(globalThis.lastClearedTimestamp=Date.now(),chrome.runtime.sendMessage(e).catch(o=>{}),t({success:!0}),!0):e.type==="POPUP_OPENED"?(m(),t({success:!0}),!0):e.type==="GET_CRM_STATUS"?(chrome.tabs.query({active:!0,currentWindow:!0},async o=>{if(o&&o.length>0){const n=o[0],c=u(n.url);t({success:!0,isCRM:c,orgId:c?d(n.url):null})}else t({success:!1,isCRM:!1})}),!0):e.type==="NAVIGATE_TO_OPPORTUNITY"?(chrome.tabs.query({active:!0,currentWindow:!0},async o=>{if(o&&o.length>0){const n=o[0].id,c=await f(n,e.opportunityId);t({success:c})}else t({success:!1,error:"No active tab found"})}),!0):e.type==="SET_AUTO_OPEN"?(chrome.storage.local.set({autoOpen:e.enabled}),t({success:!0}),!0):(t({success:!1,error:"Unknown message type"}),!0));chrome.runtime.onInstalled.addListener(()=>{chrome.storage.local.get(["autoOpen","currentOrgId"],e=>{e.autoOpen===void 0&&chrome.storage.local.set({autoOpen:!0})})});chrome.tabs.query({},e=>{e.forEach(r=>{u(r.url)&&s.add(r.id)})});
