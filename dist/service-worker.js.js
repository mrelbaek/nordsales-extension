console.log("NordSales service worker initialized");let i=null;const c={};function l(e){if(!e)return null;const r=/https:\/\/([^.]+)\.crm\.dynamics\.com/,o=e.match(r);return o&&o[1]?(console.log("Organization ID detected:",o[1]),o[1]):null}function s(e){chrome.tabs.get(e).then(r=>{if(r&&r.url&&r.url.includes("crm.dynamics.com")){const o=l(r.url);o&&chrome.storage.local.set({currentOrgId:o,lastOrgIdUpdated:Date.now()}),chrome.tabs.sendMessage(e,{type:"CHECK_OPPORTUNITY_ID"},t=>{if(chrome.runtime.lastError){console.log("Message error:",chrome.runtime.lastError.message),chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}).catch(n=>{console.log("Error re-injecting content script:",n)});return}t&&t.organizationId&&chrome.storage.local.set({currentOrgId:t.organizationId,lastOrgIdUpdated:Date.now()}),t&&t.opportunityId?chrome.storage.local.get(["currentOpportunityId"],n=>{n.currentOpportunityId!==t.opportunityId&&(chrome.storage.local.set({currentOpportunityId:t.opportunityId,lastUpdated:Date.now(),currentUrl:t.url}),chrome.runtime.sendMessage({type:"OPPORTUNITY_DETECTED",opportunityId:t.opportunityId,organizationId:t.organizationId,timestamp:Date.now()}).catch(()=>{}))}):chrome.storage.local.get(["currentOpportunityId"],n=>{n.currentOpportunityId&&(chrome.storage.local.remove(["currentOpportunityId","lastUpdated"]),chrome.runtime.sendMessage({type:"OPPORTUNITY_CLEARED",timestamp:Date.now()}).catch(()=>{}))})})}else c[e]&&(clearInterval(c[e]),delete c[e])}).catch(()=>{c[e]&&(clearInterval(c[e]),delete c[e])})}function u(e){c[e]&&clearInterval(c[e]),c[e]=setInterval(()=>{s(e)},1e3)}chrome.tabs.onUpdated.addListener((e,r,o)=>{if(r.status==="complete"&&o.url&&o.url.includes("crm.dynamics.com")){i=e,console.log("Dynamics CRM tab updated:",e);const t=l(o.url);t&&(chrome.storage.local.set({currentOrgId:t,lastOrgIdUpdated:Date.now()}),console.log("Stored organization ID from tab update:",t)),chrome.scripting.executeScript({target:{tabId:e},files:["contentScript.js"]}).then(()=>{u(e)}).catch(n=>{console.error("Error injecting content script:",n)}),chrome.storage.local.get(["autoOpen"],n=>{n.autoOpen!==!1&&(chrome.action.setBadgeText({text:"!"}),chrome.action.setBadgeBackgroundColor({color:"#0078d4"}))})}else r.status==="complete"&&o.url&&!o.url.includes("crm.dynamics.com")&&chrome.action.setBadgeText({text:""})});chrome.tabs.onRemoved.addListener(e=>{c[e]&&(clearInterval(c[e]),delete c[e])});chrome.action.onClicked.addListener(e=>{chrome.sidePanel.open({tabId:e.id}).then(()=>{chrome.action.setBadgeText({text:""})}).catch(r=>{console.error("Error opening side panel:",r)})});chrome.runtime.onMessage.addListener((e,r,o)=>(console.log("Service worker received message:",e.type),e.type==="OPPORTUNITY_DETECTED"?(console.log("Received opportunity ID:",e.opportunityId),chrome.storage.local.set({currentOpportunityId:e.opportunityId,lastUpdated:e.timestamp||Date.now()}),e.organizationId&&chrome.storage.local.set({currentOrgId:e.organizationId,lastOrgIdUpdated:Date.now()}),chrome.runtime.sendMessage(e).catch(t=>{console.log("Could not forward message to side panel (probably not open)")})):e.type==="OPPORTUNITY_CLEARED"?(console.log("Opportunity cleared"),chrome.storage.local.remove(["currentOpportunityId","lastUpdated"]),chrome.runtime.sendMessage(e).catch(t=>{console.log("Could not forward message to side panel")})):e.type==="POPUP_OPENED"?(console.log("Side panel opened, checking for current opportunity"),i&&chrome.tabs.get(i).then(t=>{if(t&&t.url&&t.url.includes("crm.dynamics.com")){const n=l(t.url);n&&chrome.storage.local.set({currentOrgId:n,lastOrgIdUpdated:Date.now()}),chrome.tabs.sendMessage(i,{type:"CHECK_OPPORTUNITY_ID"},a=>{if(chrome.runtime.lastError){console.log("Error communicating with content script:",chrome.runtime.lastError.message);return}a&&a.organizationId&&chrome.storage.local.set({currentOrgId:a.organizationId,lastOrgIdUpdated:Date.now()}),a&&a.opportunityId&&(console.log("Got opportunity ID from content script:",a.opportunityId),chrome.storage.local.set({currentOpportunityId:a.opportunityId,lastUpdated:Date.now()}),chrome.runtime.sendMessage({type:"OPPORTUNITY_DETECTED",opportunityId:a.opportunityId,organizationId:a.organizationId,timestamp:Date.now()}).catch(d=>{console.log("Could not send to side panel:",d)}))})}}).catch(t=>{console.log("Tab no longer exists:",t)})):e.type==="SET_AUTO_OPEN"&&(chrome.storage.local.set({autoOpen:e.enabled}),o({success:!0})),!0));chrome.runtime.onInstalled.addListener(()=>{console.log("NordSales extension installed/updated"),chrome.storage.local.get(["autoOpen","currentOrgId"],e=>{e.autoOpen===void 0&&chrome.storage.local.set({autoOpen:!0})})});
